<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bicep Curl Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <style>
        #userVideo {
            display: none; /* Hide the video element */
        }
        #videoCanvas {
            border: 2px solid black;
            width: 100%;
            max-width: 640px;
            background-color: #f8f9fa;
        }
        .rep-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(245, 117, 16, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h1 class="text-center">Bicep Curl Tracker</h1>
        <p class="text-center">Your reps and angles will be tracked and displayed in real-time.</p>

        <div class="text-center">
            <button id="startButton" class="btn btn-primary mb-3">Start Camera</button>
            <button id="resetButton" class="btn btn-danger mb-3">Reset Counter</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary mb-3">Back to Home</a>
        </div>

        <div class="mt-4 text-center">
            <h3>Camera Feed:</h3>
            <div id="cameraError" class="alert alert-danger d-none">
                Unable to access camera. Please ensure:
                <ul class="mb-0 text-start">
                    <li>Camera is connected and not being used by another application</li>
                    <li>You've granted camera permissions in your browser</li>
                    <li>You're using a supported browser (Chrome/Firefox/Edge recommended)</li>
                </ul>
                <button class="btn btn-primary mt-2" onclick="retryCamera()">Retry Camera Access</button>
            </div>
            <div id="loadingMessage" class="alert alert-info d-none">
                Initializing camera... Please wait and accept any permission requests.
            </div>
            <div id="videoContainer" class="d-none position-relative">
                <video id="userVideo" autoplay playsinline></video>
                <canvas id="videoCanvas"></canvas>
                <div class="rep-counter">
                    <h4 class="mb-0">Reps: <span id="repCounter">0</span></h4>
                    <h4 class="mb-0">Stage: <span id="stageIndicator">--</span></h4>
                </div>
            </div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const videoContainer = document.getElementById('videoContainer');
        const userVideo = document.getElementById('userVideo');
        const videoCanvas = document.getElementById('videoCanvas');
        const loadingMessage = document.getElementById('loadingMessage');
        const cameraError = document.getElementById('cameraError');
        const repCounter = document.getElementById('repCounter');
        const stageIndicator = document.getElementById('stageIndicator');

        let isProcessing = false;
        let frameCount = 0;

        async function startCamera() {
            loadingMessage.classList.remove('d-none');
            cameraError.classList.add('d-none');
            videoContainer.classList.add('d-none');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    } 
                });
                
                userVideo.srcObject = stream;
                userVideo.onloadedmetadata = () => {
                    userVideo.play();
                    videoContainer.classList.remove('d-none');
                    loadingMessage.classList.add('d-none');
                    startVideoProcessing();
                };
            } catch (err) {
                console.error('Error starting camera:', err);
                loadingMessage.classList.add('d-none');
                cameraError.classList.remove('d-none');
            }
        }

        function startVideoProcessing() {
            const ctx = videoCanvas.getContext('2d');
            videoCanvas.width = 640;
            videoCanvas.height = 480;

            async function processFrame() {
                if (!isProcessing) {
                    isProcessing = true;
                    frameCount++;
                    
                    try {
                        // Only process every 3rd frame to reduce server load
                        if (frameCount % 3 === 0) {
                            ctx.drawImage(userVideo, 0, 0, videoCanvas.width, videoCanvas.height);
                            
                            const blob = await new Promise(resolve => videoCanvas.toBlob(resolve, 'image/jpeg'));
                            const formData = new FormData();
                            formData.append('frame', blob);

                            const response = await fetch('/process_frame', {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();
                            if (result.reps !== undefined) {
                                repCounter.textContent = result.reps;
                                stageIndicator.textContent = result.stage || '--';
                            }
                        } else {
                            // Just update the display without processing
                            ctx.drawImage(userVideo, 0, 0, videoCanvas.width, videoCanvas.height);
                        }
                    } catch (error) {
                        console.error('Error processing frame:', error);
                    } finally {
                        isProcessing = false;
                    }
                }
                requestAnimationFrame(processFrame);
            }

            processFrame();
        }

        function retryCamera() {
            if (userVideo.srcObject) {
                userVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            startCamera();
        }

        async function resetCounter() {
            try {
                const response = await fetch('/reset_counter');
                const result = await response.json();
                repCounter.textContent = result.reps;
                stageIndicator.textContent = '--';
            } catch (error) {
                console.error('Error resetting counter:', error);
            }
        }

        startButton.addEventListener('click', startCamera);
        resetButton.addEventListener('click', resetCounter);

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (userVideo.srcObject) {
                userVideo.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
